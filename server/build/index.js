!function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=15)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t){class n extends Error{constructor(e,t,n=!0){super(e),this.message=e,this.statusCode=t,this.status=(""+t).startsWith("4")?"fail":"error",this.isOperational=n,Error.captureStackTrace(this,this.constructor)}}e.exports=n},function(e,t,n){const s=n(4),r=n(2),a=n(27);t.deleteOne=e=>s(async(t,n,s)=>{if(!await e.findByIdAndDelete(t.params.id))return s(new r("No document found with that ID",200));n.status(204).json({status:"success",requestedAt:t.requestTime,results:0,data:{data:null}}),s()}),t.updateOne=e=>s(async(t,n,s)=>{const r=await e.findByIdAndUpdate(t.params.id,t.body,{new:!0,runValidators:!0});n.status(200).json({status:"success",requestedAt:t.requestTime,results:r.length,data:{data:r}}),s()}),t.createOne=e=>s(async(t,n,s)=>{const r=await e.create(t.body);n.status(201).json({status:"success",requestedAt:t.requestTime,results:r.length,data:{data:r}}),s()}),t.getOne=(e,t)=>s(async(n,s,a)=>{let i=e.findById(n.params.id);t&&(i=i.populate(t));const o=await i;if(!o)return a(new r("No document found with that ID"),404);s.status(200).json({status:"success",requestedAt:n.requestTime,results:o.length,data:{data:o}}),a()}),t.getAll=e=>s(async(t,n,s)=>{let r={};t.params.customerID&&(r={customer:t.params.customerID});const i=new a(e.find(r),t.query).filter().sort().limitFields().paginate(),o=await i.query;n.status(200).json({status:"success",requestedAt:t.requestTime,data:{data:o}}),s()})},function(e,t){e.exports=e=>(t,n,s)=>{e(t,n,s).catch(s)}},function(e,t){e.exports=require("validator")},function(e,t,n){const s=n(0),r=n(5),a=n(12),i=(n(2),new s.Schema({_id:{type:String,default:a.generate},url:{type:String,validate:r.default.isURL},stock:{type:Number,default:0,min:0},name:{type:String,required:[!0,"Tên sản phẩm không thể bỏ trống !"]},provider:{type:String},image:{type:String,validate:r.default.isURL},discounted_price:{type:Number,required:[!0,"Giá giảm không thể bỏ trống !"]},retail_price:{type:Number,required:[!0,"Giá gốc không thể bỏ trống !"]},sell_price_vnd:{type:Number,required:[!0,"Giá bán không thể bỏ trống !"]}})),o=s.model("Product",i);e.exports=o},function(e,t,n){const s=n(0),r=n(8),a=n(2),i=()=>r(10),o=new s.Schema({_id:{type:String,default:()=>`DH${r(2)}${r(5)}`},status:{type:String,enum:["pending","fulfilled","ausvnshipped","vnchecked","completed"],default:"pending"},customer:{type:String,ref:"Customer",required:[!0,"Đơn hàng phải có thông tin khách"],autopopulate:!0},timestamp:{created:{type:Date,default:Date.now},ausvnshipped:Date,vnchecked:Date,completed:Date},payments:{type:[{_id:{type:String,default:i},payment_type:{type:String,enum:["cash","card"],required:[!0,"Xin nhập phương thức thanh toán"]},timestamp:{type:Date,default:Date.now()},total:{type:Number,required:[!0,"Xin nhập số tiền thanh toán"]}}],validate:{async validator(e){if(this instanceof s.Query){return(await this.model.findOne()).payment_due-e[0].total>0}return!0},message:"Tiền thanh toán không lớn hơn giá trị đơn"}},shipments:{type:[{_id:{type:String,default:i},timestamp:{type:Date,default:Date.now()},description:String,total:Number,products:{type:[{_id:{type:String,ref:"Product",autopopulate:!0},ship_qty:{type:Number,min:[1,"Số lượng phải lớn hơn 0"]},total:Number}]}}]},products:{type:[{_id:{type:String,ref:"Product",autopopulate:!0},quantity:{type:Number,min:[1,"Số lượng phải lớn hơn 0"]},shipped:{type:Number,default:0},payed:{type:Number,default:0},total:Number}],required:[!0,"Đơn hàng phải có sản phẩm"],validate:{validator:e=>e.length>0,message:"Đơn hàng phải có ít nhất một sản phẩm"}},total:{type:Number,required:[!0,"Đơn hàng phải có tổng tiền"]},description:{type:String,default:""},finance_ref:{type:String,ref:"Finance"}},{toJSON:{virtuals:!0},toObject:{virtuals:!0}});o.plugin(n(9)),o.pre("validate",(function(e){this.products.forEach(t=>{t.shipped>t.quantity?e(new a("Hàng đã ship không thể lớn hơn đã đặt",400)):t.payed>t.quantity&&e(new a("Hàng đã thu tiền không thể lớn hơn đã đặt",400))}),e()})),o.virtual("payment_due").get((function(){const e=this.payments.reduce((e,t)=>e+t.total,0);return this.total-e})),o.post(/^findOneAnd|^findOne|update|save/g,(async function(e,t){let n=0;console.log(e),e.products.forEach(e=>{e.shipped===e.quantity&&n++}),n===e.products.length&&0===e.payment_due&&"completed"!==e.status&&(e.status="completed",e.timestamp.completed=Date.now(),await e.save()),t()})),o.post("update",(function(e,t,n){console.log("hello")}));const u=s.model("Order",o);e.exports=u},function(e,t){e.exports=require("number-uid")},function(e,t){e.exports=require("mongoose-autopopulate")},function(e,t,n){const s=n(0),r=n(40),a=n(3),i=n(4),o=n(7),u=n(13);t.createFinancialPeriod=a.createOne(r),t.updateFinancialPeriod=a.updateOne(r),t.deleteFinancialPeriod=a.deleteOne(r),t.getFinancialPeriod=a.getOne(r),t.getAllFinancialPeriods=a.getAll(r),t.attachFinanceRef=i(async(e,t,n)=>{let s=await r.findOne().sort({$natural:-1}).limit(1);s||(s=await r.create({})),e.body.finance_ref=s._id,n()}),t.gatherDependencies=i(async(e,t,n)=>{const a=await s.startSession();await a.withTransaction(async()=>{const e=await r.findOne().sort({$natural:-1}).limit(1).session(a),t=await o.find({finance_ref:e._id}).session(a);e.orders=t.map(e=>e._id);const n=await u.find({finance_ref:e._id}).session(a);e.stockings=n.map(e=>e._id),await e.save()}),n()}),t.getLatestFinancialPeriod=i(async(e,t,n)=>{const s=await r.findOne().sort({$natural:-1}).limit(1);t.status(200).json({status:"success",data:{data:s}})}),t.closeFinancialPeriod=i(async(e,t,n)=>{const s=await r.findOne().sort({$natural:-1}).limit(1);s.timestamp.end=Date.now(),await s.save(),n()})},function(e,t,n){const s=n(0),r=(n(5),n(12)),a=new s.Schema({_id:{type:String,default:r.generate},name:{type:String,required:[!0,"Name cannot be empty !"],text:!0},address:{type:String,required:[!0,"Address cannot be empty !"]},phone:{type:String,required:[!0,"Phone cannot be empty !"],validate:[/^(?:\+?([0-90-9]))? ?(?:\((?=.*\)))?(0?[0-90-9])\)? ?(\d\d(?:[- ](?=\d{3})|(?!\d\d[- ]?\d[- ]))\d\d[- ]?\d[- ]?\d{3})$/,"Phone number is in wrong format !!"]},email:{type:String}}),i=s.model("Customer",a);e.exports=i},function(e,t){e.exports=require("shortid")},function(e,t,n){const s=n(0),r=n(8),a=new s.Schema({_id:{type:String,default:()=>`NH${r(2)}${r(7)}`},timestamp:{type:Date,default:Date.now},products:{type:[{_id:{type:String,ref:"Product",autopopulate:!0},import_qty:{type:Number,min:[0,"Số lượng phải lớn hơn 0"]},total:Number}],required:[!0,"Nhập hàng phải có sản phẩm"],validate:{validator:e=>e.length>0,message:"Nhập hàng phải có ít nhất một sản phẩm"}},total:{type:Number,required:[!0,"Nhập hàng phải có tổng tiền"]},description:{type:String,default:""},finance_ref:{type:String,ref:"Finance"}});a.plugin(n(9));const i=s.model("Stocking",a);e.exports=i},function(e,t){e.exports=require("crypto")},function(e,t,n){const s=n(0),r=n(16)("thuyonlinesales:server"),a=n(17),i=n(18),o=n(19);i.config({path:"./config.env"});let u=process.env.DATABASE;u=u.replace("<DATABASE_USERNAME>",process.env.DATABASE_USERNAME),u=u.replace("<DATABASE_PASSWORD>",process.env.DATABASE_PASSWORD),s.connect(u,{useNewUrlParser:!0,useCreateIndex:!0,useFindAndModify:!1,useUnifiedTopology:!0}).then(()=>{console.log("DB connection successful")});const c=function(e){const t=parseInt(e,10);if(isNaN(t))return e;if(t>=0)return t;return!1}(process.env.PORT||"3001");o.set("port",c);const d=a.createServer(o);d.listen(c),d.on("error",(function(e){if("listen"!==e.syscall)throw e;const t="string"==typeof c?"Pipe "+c:"Port "+c;switch(e.code){case"EACCES":console.error(t+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(t+" is already in use"),process.exit(1);break;default:throw e}})),d.on("listening",(function(){const e=d.address(),t="string"==typeof e?"pipe "+e:"port "+e.port;console.log(`App running on port ${c} as production`),r("Listening on "+t)}))},function(e,t){e.exports=require("debug")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("dotenv")},function(e,t,n){const s=n(1),r=n(20),a=n(21),i=n(22),o=n(23),u=n(2),c=n(24),d=n(25),p=n(28),l=n(31),h=n(33),g=n(38),m=n(41),f=n(43),y=n(44),w=n(45),v=s();v.set("views",r.join(__dirname,"views")),v.set("view engine","pug"),v.use(i("dev")),v.use(s.json()),v.use(s.urlencoded({extended:!1})),v.use(a()),v.use(o()),v.use(s.static(r.join(__dirname,"public"))),v.use("/",c),v.use("/api/v1/customer",d),v.use("/api/v1/crawler",p),v.use("/api/v1/product",l),v.use("/api/v1/fx",h),v.use("/api/v1/order",g),v.use("/api/v1/stock",m),v.use("/api/v1/finance",y),v.use("/api/v1/admin",w),v.all("*",(e,t,n)=>{t.headersSent||n(new u(`Can't find ${e.originalUrl} on this server!`,404)),t.end()}),v.use(f),e.exports=v},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("compression")},function(e,t,n){const s=n(1).Router();s.get("/",(e,t,n)=>{t.render("index",{title:"Express"})}),e.exports=s},function(e,t,n){const s=n(1).Router(),r=n(26);s.route("/:id").get(r.getCustomer),s.route("/").get(r.getAllCustomers).post(r.createCustomer),e.exports=s},function(e,t,n){const s=n(11),r=n(3);t.createCustomer=r.createOne(s),t.updateCustomer=r.updateOne(s),t.deleteCustomer=r.deleteOne(s),t.getCustomer=r.getOne(s),t.getAllCustomers=r.getAll(s)},function(e,t){e.exports=class{constructor(e,t){this.query=e,this.queryParams=t}filter(){const e={...this.queryParams};if(["page","sort","limit","fields"].forEach(t=>delete e[t]),e.name){const t=e.name;delete e.name,e.$text={$search:t}}let t=JSON.stringify(e);return t=t.replace(/\b(gte|gt|lte|lt)\b/g,e=>"$"+e),this.query=this.query.find(JSON.parse(t)),this}sort(){if(this.queryParams.sort){const e=this.queryParams.sort.split(",").join(" ");this.query=this.query.sort(e)}else this.query=this.query.sort("-createdAt");return this}limitFields(){if(this.queryParams.fields){const e=this.queryParams.fields.split(",").join(" ");this.query=this.query.select(e)}return this}paginate(){if(this.queryParams.page){const e=1*this.queryParams.page,t=1*this.queryParams.limit||10,n=(e-1)*t;this.query=this.query.skip(n).limit(t)}return this}}},function(e,t,n){const s=n(1).Router(),r=n(29);s.route("/product").get(r.productCrawler),e.exports=s},function(e,t,n){const s=n(30),r=async(e,t)=>{switch(t){case"www.chemistwarehouse.com.au":return await(async e=>await e.evaluate(()=>{const e=document.querySelector(".product-name > h1").innerText.trim(),t=document.querySelector("img.product-thumbnail").src.trim(),n=document.querySelector(".product__price").innerText.match(/[0-9]+\.[0-9][0-9]/g)[0];let s=document.querySelector(".retailPrice").innerText.match(/[0-9]+\.[0-9][0-9]/g)[0];return"0.00"===s&&(s=n),{url:document.URL,provider:"Chemist Warehouse",name:e,image:t,discounted_price:n,retail_price:s}}))(e);default:return null}};t.productCrawler=async(e,t,n)=>{const a=new URL(e.query.url),i=await s.launch({headless:!0}),o=await i.newPage();await o.setRequestInterception(!0),o.on("request",e=>{"stylesheet"===e.resourceType()||"font"===e.resourceType()||"image"===e.resourceType?e.abort():e.continue()}),await o.goto(a.href,{waitUntil:"domcontentloaded"});const u=await r(o,a.hostname);await i.close(),t.status(200).json({status:"success",data:{data:u}})}},function(e,t){e.exports=require("puppeteer")},function(e,t,n){const s=n(1).Router(),r=n(32);s.route("/tobuy").get(r.getToBuyProducts),s.route("/").get(r.getAllProducts).post(r.createProduct),s.route("/:id").patch(r.updateProduct),e.exports=s},function(e,t,n){const s=n(6),r=n(7),a=n(11),i=n(3),o=n(4);n(2);t.createProduct=i.createOne(s),t.updateProduct=i.updateOne(s),t.deleteProduct=i.deleteOne(s),t.getProduct=i.getOne(s),t.getAllProducts=i.getAll(s),t.getToBuyProducts=o(async(e,t,n)=>{await r.aggregate([{$match:{status:"pending"}},{$unwind:"$products"},{$group:{_id:"$products._id",tobuy:{$sum:"$products.quantity"},customers:{$push:{_id:"$customer",quantity:"$products.quantity"}}}}]).exec(async(e,n)=>{n=await s.populate(n,{path:"_id"}),await Promise.all(n.map(e=>(async()=>{e=await a.populate(e.customers,{path:"_id"})})())),t.status(200).json({status:"success",data:{data:n}})})})},function(e,t,n){const s=n(1).Router(),r=n(34);s.route("/").get(r.getAUD_VND_rateAPI),e.exports=s},function(e,t,n){const s=n(35),r=n(36),a=n(37);t.getAUD_VND_rateAPI=async(e,t,n)=>{const i=new r.Agent({rejectUnauthorized:!1}),o=await s.get("https://www.vietcombank.com.vn/exchangerates/ExrateXML.aspx",{httpsAgent:i,headers:{"User-Agent":"Mozilla/5.0 ( compatible ) ",Accept:"*/*"}}),u=JSON.parse(a.xml2json(o.data,{compact:!0}));u.ExrateList.Exrate=u.ExrateList.Exrate.map(e=>e._attributes),t.status(200).json({status:"success",data:{datetime:u.ExrateList.DateTime._text,data:u.ExrateList.Exrate}})}},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("xml-js")},function(e,t,n){const s=n(1).Router(),r=n(39),a=n(10);s.route("/:id/ship").post(r.shipMultipleItems),s.route("/:id/pay").post(r.createPayment),s.route("/:id").get(r.getOrder),s.route("/").get(r.getAllOrders).post(a.attachFinanceRef,r.createOrder,a.gatherDependencies),e.exports=s},function(e,t,n){const s=n(0),r=n(7),a=n(6),i=n(3),o=n(4);n(2);t.createOrder=i.createOne(r),t.updateOrder=i.updateOne(r),t.deleteOrder=i.deleteOne(r),t.getOrder=i.getOne(r),t.getAllOrders=i.getAll(r),t.shipMultipleItems=o(async(e,t,n)=>{const i=e.params.id,{products:o}=e.body,u=await s.startSession();let c=null;await u.withTransaction(()=>Promise.all([...o.map(async e=>{const t=await a.findById(e._id).session(u);t.stock-=e.ship_qty,await t.save()}),(async()=>{c=await r.findById(i).session(u),o.forEach(e=>{for(let t=0;t<c.products.length;t++){const n=c.products[t];String(n._id._id)===e._id&&(n.shipped+=e.ship_qty)}}),c.shipments.push(e.body),await c.save()})()])),t.status(200).json({status:"success",data:{data:c}})}),t.createPayment=o(async(e,t,n)=>{const s=e.params.id,a=await r.findById(s);a.payments.push(e.body),await a.save(),t.status(200).json({status:"success",data:{data:a}})})},function(e,t,n){const s=n(0),r=n(8),a=new s.Schema({_id:{type:String,default:()=>`FN${r(2)}${r(5)}`},orders:[{type:String,ref:"Order",autopopulate:!0}],stockings:[{type:String,ref:"Stocking",autopopulate:!0}],expenses:[{total:Number,description:String,payment_type:{type:String,enum:["cash","card"],required:[!0,"Xin nhập phương thức thanh toán"]},currency:{type:String,enum:["VND","AUD"],required:[!0,"Xin nhập loại tiền tệ"]}}],timestamp:{start:{type:Date,default:Date.now()},end:Date}},{toJSON:{virtuals:!0},toObject:{virtuals:!0}});a.plugin(n(9)),a.virtual("revenues_curr_vnd").get((function(){return this.orders.reduce((e,t)=>e+(t.total-t.payment_due),0)})),a.virtual("revenues_after_vnd").get((function(){return this.orders.reduce((e,t)=>e+t.total,0)})),a.virtual("funds_aud").get((function(){return this.stockings.reduce((e,t)=>e+t.total,0)+this.expenses.reduce((e,t)=>e+t.total,0)}));const i=s.model("Finance",a);e.exports=i},function(e,t,n){const s=n(1).Router(),r=n(42),a=n(10);s.route("/import").post(a.attachFinanceRef,r.importStock,a.gatherDependencies),s.route("/history").get(r.getStockingHistory),e.exports=s},function(e,t,n){const s=n(0),r=n(13),a=n(4),i=n(2),o=n(6),u=n(3);t.getStockRecord=u.getOne(r),t.getStockingHistory=u.getAll(r),t.importStock=a(async(e,t,n)=>{console.log(e.body);const a=await s.startSession();try{let s=null;await a.withTransaction(()=>Promise.all([...e.body.products.map(async e=>{await o.findByIdAndUpdate(e._id,{$inc:{stock:e.import_qty}},{upsert:!0,new:!0}).session(a)}),(async()=>{s=await r.create([{products:e.body.products,total:e.body.total,finance_ref:e.body.finance_ref}],{session:a})})()])),t.status(200).json({status:"success",data:{data:s}})}catch(e){0,n(new i(e.message,500))}finally{await a.endSession(),n()}})},function(e,t,n){const s=n(2);e.exports=(e,t,n,r)=>{e.statusCode=e.statusCode||500,e.status=e.status||"error","CastError"===e.name?e=(e=>{const t=`Không đúng ${e.path}: ${e.value}`;return new s(t,400)})(e):11e3===e.code?e=(e=>{const t=e.errmsg.match(/(["'])(\\?.)*?\1/)[0];return new s(`Dữ liệu tồn tại: ${t}. Xin điền giá trị khác!`,400)})(e):"ValidationError"===e.name?e=(e=>{const t=Object.values(e.errors).map(e=>e.message);return new s("Dữ liệu nhập không đúng định dạng: "+t,400)})(e):"JsonWebTokenError"===e.name?e=new s("Không thể xác thực phiên đăng nhập. Xin đăng nhập lại",401):"TokenExpiredError"===e.name&&(e=new s("Phiên đăng nhập của bạn đã hết hạn",401)),((e,t)=>{e.isOperational?t.status(e.statusCode).json({status:e.status,message:e.message}):(console.error("*****ERROR*****\n",e),t.status(500).json({status:"error",message:"Có lỗi xảy ra"}))})(e,n)}},function(e,t,n){const s=n(1).Router(),r=n(10);s.route("/end").post(r.closeFinancialPeriod,r.createFinancialPeriod),s.route("/latest").get(r.getLatestFinancialPeriod),s.route("/:id").get(r.getFinancialPeriod),s.route("/").get(r.getAllFinancialPeriods).post(r.createFinancialPeriod),e.exports=s},function(e,t,n){const s=n(1).Router(),r=n(46);s.post("/signup",r.signup),s.post("/login",r.login),s.post("/logout",r.logout),s.post("/forgot_password",r.forgotPassword),s.patch("/reset_password/:token",r.resetPassword),s.use(r.protected),s.patch("/update_password",r.updatePassword),s.route("/me").get(r.getMe,r.getAdmin),e.exports=s},function(e,t,n){const s=n(47),r=n(14),a=n(48),i=n(4),o=n(2),{sendEmail:u}=n(50),c=n(3),d=(e,t,n)=>{const r=(a=e._id,s.sign({id:a},process.env.JWT_SECRET,{expiresIn:process.env.JWT_EXPIRES_IN}));var a;["password","passwordChangedAt","salt","__v"].forEach(t=>{e[t]=void 0});const i={expires:new Date(Date.now()+24*process.env.JWT_COOKIES_EXPIRES_IN*60*60*1e3),httpOnly:!0,secure:!0};n.cookie("jwt",r,i),n.status(t).json({status:"success",data:{admin:e}})};t.signup=i(async(e,t)=>{const n=await a.create({name:e.body.name,email:e.body.email,password:e.body.password});d(n,201,t)}),t.login=i(async(e,t,n)=>{const{email:s,password:r}=e.body;if(!s||!r)return n(new o("Không tìm thấy email hoặc mật khẩu !",400));const i=await a.findOne({email:s}).select("+password");if(!i||!await i.checkCorrectness(r,i.password))return n(new o("Email hoặc mật khẩu không đúng",401));d(i,200,t)}),t.logout=i(async(e,t,n)=>{t.clearCookie("jwt"),t.status(204).json({status:"success",data:null})}),t.protected=i(async(e,t,n)=>{const r=e.cookies.jwt;if(!r)return n(new o("Bạn chưa đăng nhập !! Vui lòng đăng nhập để sử dụng tính năng.",401));const i=s.verify(r,process.env.JWT_SECRET),u=await a.findById(i.id);return u?u.changedPasswordAfter(i.iat)?n(new o("Người dùng gần đây thay đổi mật khẩu, xin đăng nhập lại",401)):(e.admin=u,void n()):n(new o("Người dùng gắn với mã token không còn tồn tại",401))}),t.restrictTo=(...e)=>(t,n,s)=>{if(!e.includes(t.admin.role))return s(new o("Bạn không có đủ quyền hạn để sử dụng tính năng này",403));s()},t.forgotPassword=i(async(e,t,n)=>{const s=await a.findOne({email:e.body.email});if(!s)return n(new o("Không có người dùng với Email đề cập",404));const r=s.createPasswordResetToken();await s.save({validateBeforeSave:!1});const i=`Bạn quên Mật Khẩu? Điền PATCH, mật khẩu mới cùng với url: ${`${e.protocol}://${e.get("host")}/api/v1/admin/reset_password/${r})`}. \n \n  Nếu bạn không yêu cầu làm lại mật khẩu, xin bỏ qua email này.`;try{await u({email:s.email,subject:"Link làm mới mật khẩu {khả dụng trong 10 phút)",message:i}),t.status(200).json({status:"success",message:"Link làm mới đã được gởi tới mail"})}catch(e){return s.passwordResetToken=void 0,s.passwordResetExpires=void 0,await s.save({validateBeforeSave:!1}),n(new o("Có lỗi trong khi gởi email. Xin thử lại lúc khác!",500))}}),t.resetPassword=i(async(e,t,n)=>{const s=r.createHash("sha256").update(e.params.token).digest("hex"),i=await a.findOne({passwordResetToken:s,passwordResetExpires:{$gt:Date.now()}});if(!i)return n(new o("Link làm lại Mật Khẩu đã hết hạn",400));i.password=e.body.password,i.passwordResetToken=void 0,i.passwordResetExpires=void 0,await i.save(),d(i,200,t)}),t.updatePassword=i(async(e,t,n)=>{const s=await a.findOne(e.admin._id).select("+password");if(!await s.checkCorrectness(e.body.currentPassword,s.password))return n(new o("Bạn nhập sai Mật Khẩu hiện tại",401));s.password=e.body.newPassword,await s.save(),d(s,200,t)}),t.getMe=(e,t,n)=>{e.params.id=e.admin.id,n()},t.getAdmin=c.getOne(a)},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){const s=n(14),r=n(0),a=n(5),i=n(49),o=new r.Schema({name:{type:String,required:[!0,"Tên người dùng bị thiếu"]},email:{type:String,required:[!0,"Không tìm thấy email"],unique:!0,lowercase:!0,validate:[a.isEmail,"Email không hợp lệ"]},password:{type:String,required:[!0,"Không tìm thấy mật khẩu"],minlength:8,select:!1},passwordChangedAt:{type:Date,select:!1},passwordResetToken:String,passwordResetExpires:Date,salt:{type:String,select:!1}});o.pre("save",(async function(e){if(!this.isModified("password"))return e();if(!this.salt){const e=await i.genSalt(10);this.salt=e}this.password=await i.hash(this.password,this.salt),e()})),o.pre("save",(async function(e){if(!this.isModified("password"))return e();this.passwordChangedAt=Date.now()-1e3,e()})),o.pre(/^find/,(function(e){this.find({active:{$ne:!1}}),e()})),o.methods.checkCorrectness=async function(e,t){return await i.compare(e,t)},o.methods.changedPasswordAfter=function(e){if(this.passwordChangedAt){return e<parseInt(this.passwordChangedAt.getTime()/1e3,10)}return!1},o.methods.createPasswordResetToken=function(){const e=s.randomBytes(32).toString("hex");return this.passwordResetToken=s.createHash("sha256").update(e).digest("hex"),this.passwordResetExpires=Date.now()+6e5,e};const u=r.model("Admin",o);e.exports=u},function(e,t){e.exports=require("bcryptjs")},function(e,t,n){const s=n(51);t.sendEmail=async e=>{const t=s.createTransport({host:process.env.EMAIL_HOST,port:process.env.EMAIL_PORT,auth:{user:process.env.EMAIL_USERNAME,pass:process.env.EMAIL_PASSWORD}}),n={from:"TravelS Security<travels_security@travels.io>",to:e.email,subject:e.subject,text:e.message};await t.sendMail(n)}},function(e,t){e.exports=require("nodemailer")}]);